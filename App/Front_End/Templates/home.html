{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %}

<h1 class="mb-4">Money Manager</h1>

<!-- Top bar simplified -->
<div class="mb-3">
  <p class="mb-0 text-muted"><strong>Session Mode:</strong> In-Memory (data resets when app restarts)</p>
</div>

<!-- Budget Summary -->
<div class="card shadow-sm mb-4">
  <div class="card-header">Budget Summary</div>
  <div class="card-body">
    <div class="row align-items-start">
      
      <!-- Square pie chart (left) -->
      <div class="col-md-5 mb-3 d-flex flex-column align-items-center">
        <p class="mb-2"><strong>Spending by Category</strong></p>
        <div class="border rounded p-2 d-flex align-items-center justify-content-center" style="width: 260px; height: 260px;">
          <canvas id="categoryChart" width="260" height="260"></canvas>
        </div>
      </div>

      <!-- Totals + compact category summary (right) -->
      <div class="col-md-7">
        <div class="row">
          <!-- Totals (narrow) -->
          <div class="col-12 col-lg-5">
            <p class="mb-1"><strong>Totals</strong></p>
            <ul class="list-unstyled mb-3 small">
              <li class="mb-1">Total Spent: <strong>${{ '%.2f' % total_spent }}</strong></li>
              <li class="mb-1">Remaining Budget: <strong>${{ '%.2f' % remaining }}</strong></li>
              <li class="mb-1">Monthly Income: <strong>${{ '%.2f' % income }}</strong>
                <a href="{{ url_for('set_income') }}" class="btn btn-sm btn-outline-dark ms-2">Edit</a>
              </li>
            </ul>
          </div>
          <!-- Mini category summary -->
          <div class="col-12 col-lg-7">
            <p class="mb-1"><strong>Category Summary (top 8)</strong></p>
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead>
                  <tr>
                    <th class="text-nowrap">Category</th>
                    <th class="text-end">Spent</th>
                    <th class="text-end">Remain</th>
                  </tr>
                </thead>
                <tbody>
                  {% for c in categories[:8] %}
                  <tr>
                    <td class="text-nowrap">{{ c.name }}</td>
                    <td class="text-end">${{ '%.2f' % c.spent }}</td>
                    <td class="text-end">${{ '%.2f' % c.remaining }}</td>
                  </tr>
                  {% else %}
                  <tr><td colspan="3" class="text-muted">No categories yet.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div class="mt-2">
              <a href="{{ url_for('view_categories') }}" class="btn btn-sm btn-outline-dark">View All</a>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- /row -->
  </div>
</div>

<div class="row g-4">

  <!-- Categories -->
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">Categories</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped align-middle mb-3">
            <thead>
              <tr>
                <th>Name</th>
                <th>Spent</th>
                <th>Limit</th>
                <th>Remaining</th>
              </tr>
            </thead>
            <tbody>
              {% for category in categories %}
                <tr>
                  <td>{{ category.name }}</td>
                  <td>${{ '%.2f' % category.spent }}</td>
                  <td>${{ '%.2f' % category.limit }}</td>
                  <td>${{ '%.2f' % category.remaining }}</td>
                </tr>
              {% else %}
                <tr><td colspan="4" class="text-muted">No categories yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="btn-group">
          <a href="{{ url_for('add_category') }}" class="btn btn-outline-success">Add</a>
          <a href="{{ url_for('edit_category_select') }}" class="btn btn-outline-secondary">Edit</a>
          <a href="{{ url_for('view_categories') }}" class="btn btn-outline-dark">View</a>
        </div>
        <div class="mt-2">
          <a href="{{ url_for('category_summary') }}" class="btn btn-sm btn-outline-dark">Category Summary</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Transactions -->
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">Transactions</div>
      <div class="card-body">
        <div class="table-responsive mb-3">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Description</th>
                <th>Amount</th>
                <th>Category</th>
              </tr>
            </thead>
            <tbody>
              {% for t in transactions %}
                <tr>
                  <td>{{ t.get_description() }}</td>
                  <td>${{ '%.2f' % t.get_amount() }}</td>
                  <td>{{ t.get_category() }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="3" class="text-muted">No transactions yet.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="btn-group mb-2">
          <a href="{{ url_for('add_transaction') }}" class="btn btn-outline-primary">Add</a>
          <a href="{{ url_for('edit_transaction_select') }}" class="btn btn-outline-secondary">Edit</a>
          <a href="{{ url_for('delete_transaction') }}" class="btn btn-outline-danger">Delete</a>
          <a href="{{ url_for('view_transactions') }}" class="btn btn-outline-dark">View</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Sinking Funds -->
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-info text-white">Sinking Funds</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped align-middle mb-3">
            <thead>
              <tr>
                <th>Name</th>
                <th>Saved</th>
                <th>Goal</th>
                <th>Progress %</th>
              </tr>
            </thead>
            <tbody>
              {% for fund in funds %}
                <tr>
                  <td>{{ fund.get_name() }}</td>
                  <td>${{ '%.2f' % fund.get_current_amount() }}</td>
                  <td>${{ '%.2f' % fund.get_goal_amount() }}</td>
                  <td>{{ '%.1f' % fund.get_percent_saved() }}%</td>
                </tr>
              {% else %}
                <tr><td colspan="4" class="text-muted">No funds yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="btn-group">
          <a href="{{ url_for('add_fund') }}" class="btn btn-outline-info">Add</a>
          <a href="{{ url_for('edit_fund_select') }}" class="btn btn-outline-secondary">Edit</a>
          <a href="{{ url_for('delete_fund') }}" class="btn btn-outline-danger">Delete</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Debts -->
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-header bg-danger text-white">Debts</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped align-middle mb-3">
            <thead>
              <tr>
                <th>Name</th>
                <th>Paid</th>
                <th>Total</th>
                <th>Remaining</th>
              </tr>
            </thead>
            <tbody>
              {% for debt in debts %}
                <tr>
                  <td>{{ debt.get_name() }}</td>
                  <td>${{ '%.2f' % debt.get_amount_paid() }}</td>
                  <td>${{ '%.2f' % debt.get_total_amount() }}</td>
                  <td>${{ '%.2f' % (debt.get_total_amount() - debt.get_amount_paid()) }}</td>
                </tr>
              {% else %}
                <tr><td colspan="4" class="text-muted">No debts yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="btn-group">
          <a href="{{ url_for('add_debt') }}" class="btn btn-outline-danger">Add</a>
          <a href="{{ url_for('edit_debt_select') }}" class="btn btn-outline-secondary">Edit</a>
          <a href="{{ url_for('delete_debt') }}" class="btn btn-outline-warning">Delete</a>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Bottom spacing -->
<div class="mb-5"></div>

<!-- Chart data payloads -->
<script id="category-names" type="application/json">
  {{ (category_names | default([], true)) | tojson }}
</script>
<script id="category-spent" type="application/json">
  {{ (category_spent | default([], true)) | tojson }}
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const namesEl = document.getElementById('category-names');
  const spentEl = document.getElementById('category-spent');
  let labels = [], values = [];

  try {
    labels = JSON.parse((namesEl && namesEl.textContent) || '[]');
    values = JSON.parse((spentEl && spentEl.textContent) || '[]');
  } catch (_) {
    labels = [];
    values = [];
  }

  const el = document.getElementById('categoryChart');
  if (!el || labels.length === 0 || values.length === 0) return;

  new Chart(el.getContext('2d'), {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: [
          '#0d6efd','#198754','#ffc107','#dc3545','#0dcaf0',
          '#6f42c1','#fd7e14','#6c757d','#20c997','#6610f2'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false, /* fills 260x260 square */
      plugins: {
        legend: { display: true, position: 'bottom' }
      }
    }
  });
});
</script>

{% endblock %}
